# 文件提供者产品需求文档 (PRD)

## 1. 文档信息

- **文档版本**: 1.0
- **创建日期**: 2025-08-11
- **作者**: AI Assistant
- **审核人**:
- **相关文档**:
  - 搜索引擎架构文档
  - 数据库设计文档
  - 文件系统监视器设计文档

## 2. 概述

### 2.1 项目背景
TalexTouch是一款高效的启动器和文件搜索工具，旨在帮助用户快速访问应用程序、文件和执行各种任务。为了提升用户体验，需要实现一个文件提供者（File Provider），用于索引和搜索文件系统中的文件。

### 2.2 项目目标
1. 实现一个高性能的文件搜索提供者
2. 采用白名单机制，只索引精选的文件类型
3. 监控系统资源，智能调整索引策略
4. 提供实时文件搜索和执行功能
5. 支持文件预览和智能排序

### 2.3 项目范围
本项目涵盖文件提供者的完整实现，包括文件索引、搜索、执行、预览等功能，以及相关的配置管理和性能优化。

## 3. 业务需求

### 3.1 功能需求

#### 3.1.1 文件索引
- **FR-1**: 系统应能索引用户指定目录中的文件
- **FR-2**: 系统应采用白名单机制，只索引指定的文件类型
- **FR-3**: 系统应排除特定目录和文件（如node_modules、.git等）
- **FR-4**: 系统应支持断点续传的索引机制
- **FR-5**: 系统应提供索引进度反馈

#### 3.1.2 文件搜索
- **FR-6**: 系统应支持根据文件名和路径进行搜索
- **FR-7**: 系统应支持拼音匹配和模糊搜索
- **FR-8**: 系统应支持文件类型过滤
- **FR-9**: 系统应结合使用频率和最近使用时间进行智能排序

#### 3.1.3 文件执行
- **FR-10**: 系统应支持使用默认应用程序打开文件
- **FR-11**: 系统应支持文件预览功能
- **FR-12**: 系统应记录文件执行日志用于智能排序

#### 3.1.4 系统资源监控
- **FR-13**: 系统应监控CPU和内存使用情况
- **FR-14**: 系统应根据资源情况动态调整索引策略
- **FR-15**: 系统应在资源紧张时暂停索引操作

### 3.2 非功能需求

#### 3.2.1 性能需求
- **NFR-1**: 初始索引应在合理时间内完成（根据文件数量而定）
- **NFR-2**: 搜索响应时间应小于200ms
- **NFR-3**: 索引操作不应使CPU使用率超过80%
- **NFR-4**: 索引操作不应使内存使用超过80%

#### 3.2.2 可用性需求
- **NFR-5**: 系统应提供清晰的索引进度反馈
- **NFR-6**: 系统应允许用户暂停或取消索引操作
- **NFR-7**: 系统应提供配置界面供用户自定义设置

#### 3.2.3 兼容性需求
- **NFR-8**: 系统应支持Windows、macOS和Linux操作系统
- **NFR-9**: 系统应兼容不同的文件系统

## 4. 用户故事

### 4.1 用户角色
- **普通用户**: 使用TalexTouch进行文件搜索和执行的用户

### 4.2 用户场景

#### 场景1: 首次使用文件搜索功能
作为普通用户，当我首次使用文件搜索功能时，我希望系统能够自动索引我常用的目录中的文件，这样我就能快速搜索到需要的文件。

#### 场景2: 搜索特定文件
作为普通用户，当我需要查找特定文件时，我希望能够通过输入文件名或路径快速找到文件，并且搜索结果能够根据我的使用习惯进行排序。

#### 场景3: 打开文件
作为普通用户，当我找到需要的文件时，我希望能够通过点击搜索结果直接打开文件，并且系统能够使用正确的应用程序打开文件。

#### 场景4: 系统资源紧张时的索引操作
作为普通用户，当我的电脑正在执行其他资源密集型任务时，我希望文件索引操作不会影响我的正常使用。

## 5. 技术设计

### 5.1 架构设计

#### 5.1.1 整体架构
文件提供者将作为TalexTouch搜索引擎的一个插件实现，遵循ISearchProvider接口规范。

```
+-------------------+
|   Search Engine   |
+-------------------+
         |
         | (Implements)
         v
+-------------------+
|   File Provider   |
+-------------------+
         |
         +----------------+-----------------+------------------+
         |                |                 |                  |
         v                v                 v                  v
+----------------+ +----------------+ +----------------+ +----------------+
| File System    | | Database       | | Config Manager | | Resource Monitor|
| Watcher        | |                | |                | |                |
+----------------+ +----------------+ +----------------+ +----------------+
```

#### 5.1.2 核心组件
1. **FileProvider**: 核心实现类，负责文件索引、搜索和执行
2. **FileSystemWatcher**: 文件系统监听器，监听文件变化事件
3. **Database**: 数据库访问层，存储文件元数据和索引信息
4. **ConfigManager**: 配置管理器，管理用户配置
5. **ResourceMonitor**: 系统资源监控器，监控CPU和内存使用情况

### 5.2 数据设计

#### 5.2.1 数据库表结构
使用现有的`files`表来存储文件信息：

| 字段名 | 类型 | 描述 |
|--------|------|------|
| id | integer | 主键 |
| path | text | 文件的绝对路径（唯一） |
| name | text | 文件名 |
| extension | text | 文件扩展名 |
| size | integer | 文件大小 |
| mtime | integer | 修改时间 |
| ctime | integer | 创建时间 |
| isDir | integer | 是否为目录 |
| type | text | 文件类型（'file'） |
| content | text | 文件内容（可选，用于全文搜索） |
| embeddingStatus | text | 向量化状态（'none', 'pending', 'completed'） |
| indexStatus | text | 索引状态（'not_indexed', 'indexing', 'indexed', 'index_failed'） |

#### 5.2.2 索引状态管理
引入索引状态字段来管理文件的索引状态：
- `not_indexed`: 未索引
- `indexing`: 索引中
- `indexed`: 已索引
- `index_failed`: 索引失败

### 5.3 接口设计

#### 5.3.1 ISearchProvider接口实现
```typescript
class FileProvider implements ISearchProvider {
  readonly id = 'file-provider'
  readonly name = 'File Provider'
  readonly type = 'file' as const

  // 初始化方法
  async onLoad(context: ProviderContext): Promise<void>

  // 搜索方法
  async onSearch(query: TuffQuery): Promise<TuffItem[]>

  // 执行方法
  async onExecute(args: IExecuteArgs): Promise<void>

  // 文件系统事件处理
  private handleItemAddedOrChanged = async (event: FileAddedEvent | FileChangedEvent): Promise<void>
  private handleItemUnlinked = async (event: FileUnlinkedEvent): Promise<void>

  // 索引管理
  private startIndexing(): Promise<void>
  private pauseIndexing(): void
  private resumeIndexing(): Promise<void>
  private cancelIndexing(): Promise<void>

  // 进度反馈
  private reportProgress(progress: number, message: string): void
}
```

#### 5.3.2 配置接口
```typescript
interface FileProviderConfig {
  // 索引目录
  indexPaths: string[]

  // 白名单文件类型
  whitelistExtensions: string[]

  // 黑名单目录名
  blacklistDirectories: string[]

  // 最大文件大小限制 (MB)
  maxFileSize: number

  // 索引批处理大小
  batchSize: number

  // 索引间隔时间 (小时)
  indexInterval: number

  // CPU使用率阈值 (%)
  cpuThreshold: number

  // 内存使用率阈值 (%)
  memoryThreshold: number
}
```

## 6. 实现细节

### 6.1 默认索引目录

根据不同操作系统设置默认索引目录：

#### 6.1.1 macOS
- 用户主目录：`/Users/{username}`
- 下载目录：`/Users/{username}/Downloads`
- 文档目录：`/Users/{username}/Documents`
- 桌面目录：`/Users/{username}/Desktop`

#### 6.1.2 Windows
- 用户主目录：`C:\Users\{username}`
- 下载目录：`C:\Users\{username}\Downloads`
- 文档目录：`C:\Users\{username}\Documents`
- 桌面目录：`C:\Users\{username}\Desktop`

#### 6.1.3 Linux
- 用户主目录：`/home/{username}`
- 下载目录：`/home/{username}/Downloads`
- 文档目录：`/home/{username}/Documents`
- 桌面目录：`/home/{username}/Desktop`

### 6.2 文件过滤策略

采用严格的白名单机制，只索引指定的文件类型，避免大量无效索引：

#### 6.2.1 黑名单过滤（排除特定目录和文件）
- 隐藏文件和目录（以`.`开头）
- 系统目录（如`node_modules`、`.git`、`.svn`、`.hg`、`.npm`、`.yarn`、`.m2`等）
- 临时文件（以`~`结尾、`.tmp`、`.temp`等）
- 编译输出目录（`dist`、`build`、`target`、`out`、`bin`等）
- 日志文件（`.log`）
- 缓存目录（`cache`、`.cache`等）
- 开发工具目录（`.vscode`、`.idea`等）
- 所有代码文件（默认情况下）

#### 6.2.2 白名单过滤（只索引指定文件类型）
只索引以下类型的文件：
- 常用文档类型（`.txt`、`.pdf`、`.doc`、`.docx`、`.xls`、`.xlsx`、`.ppt`、`.pptx`、`.rtf`、`.md`等）
- 常用媒体类型（`.jpg`、`.jpeg`、`.png`、`.gif`、`.bmp`、`.mp4`、`.avi`、`.mkv`、`.mov`、`.wmv`、`.flv`、`.mp3`、`.wav`、`.flac`等）
- 常用压缩文件类型（`.zip`、`.rar`、`.7z`、`.tar`、`.gz`、`.bz2`等）
- 常用数据文件类型（`.csv`、`.json`、`.xml`、`.yaml`、`.yml`等）
- 常用电子书类型（`.epub`、`.mobi`等）
- 常用安装包类型（`.exe`、`.msi`、`.dmg`、`.deb`、`.rpm`等）

#### 6.2.3 大小限制
- 默认跳过大于5MB的文件的内容索引，但仍索引文件路径和基本信息
- 用户可自定义大小限制

### 6.3 索引建立策略

考虑到索引建立可能需要很长时间，需要采用以下策略：

#### 6.3.1 分批处理
1. 使用异步方式处理索引建立
2. 每次处理一定数量的文件后，使用`setTimeout`或`setImmediate`让出进程操作
3. 设置合理的批处理大小（例如每次处理100个文件），避免阻塞主线程

#### 6.3.2 断点续传
1. 记录索引建立的进度状态
2. 下次启动时从上次中断的位置继续
3. 使用数据库记录已处理的目录路径和文件数量

#### 6.3.3 进度反馈
1. 提供索引建立进度反馈
2. 显示已处理文件数量和总文件数量
3. 允许用户暂停或取消索引建立过程

#### 6.3.4 索引状态管理
1. 使用状态字段标识索引状态（未索引、索引中、已索引、索引失败）
2. 对于索引失败的文件，记录失败原因并提供重试机制

### 6.4 索引频率和系统资源监控

#### 6.4.1 索引频率策略
1. **初始索引**：应用首次启动时执行完整索引
2. **增量索引**：每24小时执行一次增量索引
3. **实时更新**：通过文件系统监听实现实时更新
4. **用户触发**：用户可手动触发索引更新

#### 6.4.2 系统资源监控
1. **CPU使用率监控**：
   - 索引过程中监控CPU使用率
   - 当CPU使用率超过80%时，暂停索引操作
   - 当CPU使用率降至50%以下时，恢复索引操作

2. **内存使用监控**：
   - 监控应用内存使用情况
   - 当内存使用超过80%时，减少批处理大小
   - 当内存使用超过90%时，暂停索引操作

3. **动态调整策略**：
   - 根据系统资源情况动态调整批处理大小
   - 在系统资源紧张时降低索引优先级
   - 在系统空闲时加快索引速度

4. **资源监控实现**：
   - 使用Node.js的`os`模块获取系统信息
   - 定期检查系统资源状态（每5秒检查一次）
   - 根据资源状态调整索引策略

### 6.5 文件系统事件监听处理

对于文件系统事件监听，采用以下策略：

#### 6.5.1 事件队列
1. 将所有文件系统事件存入队列
2. 批量处理队列中的事件
3. 避免频繁的数据库操作

#### 6.5.2 事件去重
1. 对于同一文件的多个事件，只处理最后一个
2. 合并添加和修改事件
3. 对于已删除的文件，忽略后续事件

#### 6.5.3 索引状态检查
1. 处理事件前检查文件是否已索引
2. 对于已索引文件，执行更新操作
3. 对于未索引文件，执行添加操作
4. 对于正在索引的文件，延迟处理事件直到索引完成

#### 6.5.4 事件处理优先级
1. 给予用户正在访问的目录更高优先级
2. 对于频繁变化的目录，采用节流策略

### 6.6 搜索功能

#### 6.6.1 基础搜索
1. 根据查询文本匹配文件名和路径
2. 支持拼音匹配
3. 支持模糊搜索
4. 支持正则表达式搜索

#### 6.6.2 高级搜索
1. 结合使用频率和最近使用时间进行排序
2. 支持文件类型过滤
3. 支持文件大小过滤
4. 支持修改时间过滤
5. 支持全文搜索（如果文件内容已索引）

#### 6.6.3 智能排序
1. 使用TF-IDF算法计算相关性得分
2. 结合用户使用习惯进行个性化排序
3. 考虑文件类型权重
4. 考虑文件位置权重（用户目录权重高于系统目录）

### 6.7 执行功能

#### 6.7.1 打开方式
1. 使用系统默认应用程序打开文件
2. 根据文件类型选择合适的打开方式
3. 支持自定义打开方式配置
4. 对于目录，打开文件管理器并定位到该目录

#### 6.7.2 文件预览
1. 对于图片文件，提供缩略图预览
2. 对于文本文件，提供内容预览（前几行）
3. 对于PDF文件，提供第一页预览
4. 对于音频/视频文件，提供基本信息预览
5. 对于其他文件，显示文件信息（大小、修改时间等）

#### 6.7.3 执行日志
1. 记录文件执行日志用于智能排序
2. 使用现有的usageLogs表记录执行信息
3. 记录执行时间和执行方式

### 6.8 文件内容索引（后续优化）

#### 6.8.1 内容提取
1. 使用适当的库提取不同文件类型的内容
2. 对于Office文档，提取文本内容
3. 对于PDF文件，提取文本内容
4. 对于代码文件，提取代码内容
5. 对于大于5MB的文件，跳过内容提取，但仍索引文件路径和基本信息

#### 6.8.2 AI Embeddings
1. 使用向量模型对文件内容进行向量化
2. 存储向量到embeddings表
3. 支持语义搜索

#### 6.8.3 摘要生成
1. 使用AI模型生成文件内容摘要
2. 存储摘要用于预览和搜索

## 7. 配置管理

### 7.1 基础配置
1. 可索引的目录路径列表（用户可自定义）
2. 文件类型过滤器（白名单）
3. 最大索引深度
4. 是否包含隐藏文件
5. 最大文件大小限制

### 7.2 高级配置
1. 索引批处理大小
2. 索引间隔时间
3. 事件处理节流时间
4. 是否启用文件内容索引
5. 是否启用AI embeddings

### 7.3 系统资源配置
1. CPU使用率阈值
2. 内存使用率阈值
3. 动态调整策略

### 7.4 用户界面
1. 提供配置界面供用户自定义设置
2. 显示索引进度和状态
3. 提供手动索引控制（开始、暂停、取消）

## 8. 性能优化

### 8.1 数据库优化
1. 为常用查询字段添加索引（path、name、extension、mtime等）
2. 使用批量插入和更新操作
3. 合理设计查询语句，避免全表扫描

### 8.2 文件系统优化
1. 使用流式处理大文件
2. 缓存常用目录结构
3. 使用适当的文件系统API

### 8.3 内存优化
1. 及时释放不需要的对象
2. 使用对象池减少GC压力
3. 控制缓存大小

### 8.4 并发优化
1. 使用异步并发处理多个文件
2. 控制并发数量避免系统资源耗尽
3. 使用适当的调度策略
4. 考虑使用Worker线程处理CPU密集型任务（如文件内容提取、向量化处理等）
5. 对于大文件处理，使用Worker线程避免阻塞主线程

## 9. 安全考虑

### 9.1 访问控制
1. 限制可索引的目录范围
2. 遵循系统文件访问权限
3. 处理无权限访问的文件

### 9.2 数据安全
1. 过滤敏感文件和目录
2. 不索引包含敏感信息的文件
3. 加密存储敏感配置信息

### 9.3 系统安全
1. 避免符号链接循环
2. 限制递归深度防止栈溢出
3. 处理恶意文件名和路径

## 10. 错误处理

### 10.1 文件系统错误
1. 处理文件不存在错误
2. 处理权限不足错误
3. 处理磁盘空间不足错误

### 10.2 数据库错误
1. 处理数据库连接错误
2. 处理SQL执行错误
3. 处理事务回滚

### 10.3 网络错误
1. 处理网络连接错误（如果涉及网络文件系统）
2. 实现重试机制

### 10.4 索引错误
1. 处理文件读取错误
2. 处理文件解析错误
3. 记录错误日志并提供重试机制

## 11. 测试计划

### 11.1 单元测试
1. 文件索引功能测试
2. 文件搜索功能测试
3. 文件执行功能测试
4. 文件系统事件处理测试
5. 配置管理测试

### 11.2 集成测试
1. 与搜索引擎集成测试
2. 与数据库集成测试
3. 与文件系统监视器集成测试
4. 与用户界面集成测试

### 11.3 性能测试
1. 大量文件索引性能测试
2. 搜索响应时间测试
3. 文件系统事件处理性能测试
4. 内存使用情况测试

### 11.4 兼容性测试
1. 不同操作系统兼容性测试
2. 不同文件系统兼容性测试
3. 不同Node.js版本兼容性测试

## 12. 部署和维护

### 12.1 部署计划
1. 与TalexTouch主应用一起打包发布
2. 提供独立的配置文件
3. 支持热更新

### 12.2 维护计划
1. 定期检查索引完整性
2. 监控系统资源使用情况
3. 收集用户反馈并持续优化

### 12.3 监控和日志
1. 记录索引操作日志
2. 监控搜索性能指标
3. 收集错误日志用于问题排查

## 13. 后续优化

### 13.1 功能优化
1. 支持全文搜索
2. 支持文件内容索引
3. 支持云存储文件搜索
4. 提供更智能的文件推荐

### 13.2 性能优化
1. 优化索引算法
2. 改进搜索算法
3. 增加缓存机制

### 13.3 用户体验优化
1. 提供更丰富的预览功能
2. 改进用户界面
3. 增加快捷键支持

## 14. 项目里程碑

### 14.1 第一阶段（基础功能）- 2周
1. 实现基本文件索引功能
2. 实现基础搜索功能
3. 实现文件执行功能
4. 实现基础配置管理

### 14.2 第二阶段（性能优化）- 3周
1. 实现分批处理和断点续传
2. 实现事件队列和去重
3. 实现进度反馈
4. 实现基础过滤机制

### 14.3 第三阶段（高级功能）- 4周
1. 实现文件预览功能
2. 实现智能排序
3. 实现高级搜索
4. 实现用户界面

### 14.4 第四阶段（后续优化）- 持续进行
1. 实现文件内容索引
2. 实现AI embeddings
3. 实现摘要生成
4. 实现云存储支持

## 15. 风险评估

### 15.1 技术风险
1. 文件系统监听可能在某些环境下不稳定
2. 大量文件索引可能导致性能问题
3. 不同操作系统的文件系统差异可能导致兼容性问题

### 15.2 性能风险
1. 索引操作可能影响系统性能
2. 搜索大量数据可能导致响应延迟
3. 内存使用过多可能导致应用崩溃

### 15.3 安全风险
1. 索引敏感文件可能导致信息泄露
2. 文件执行功能可能被恶意利用
3. 配置文件可能被篡改

### 15.4 风险缓解措施
1. 充分测试不同环境下的文件系统监听功能
2. 实现系统资源监控和动态调整策略
3. 实现严格的文件过滤机制
4. 加密存储敏感配置信息
5. 实现权限控制和输入验证

## 16. 附录

### 16.1 术语表
- **Tuff**: 一款高效的启动器和文件搜索工具
- **File Provider**: 文件提供者，用于索引和搜索文件系统中的文件
- **ISearchProvider**: 搜索提供者接口
- **白名单机制**: 只允许指定的文件类型被索引的机制
- **断点续传**: 索引过程中断后能够从中断位置继续的机制

### 16.2 参考资料
- TalexTouch项目文档
- Node.js官方文档
- SQLite数据库文档
- 操作系统文件系统相关文档

## 17. 关于Worker线程的考虑

### 17.1 是否需要Worker
在文件提供者的实现中，需要考虑是否使用Worker线程来处理某些任务：

1. **文件内容提取**：对于Office文档、PDF文件等需要复杂解析的文件，内容提取可能是一个CPU密集型任务，使用Worker线程可以避免阻塞主线程。

2. **向量化处理**：如果实现AI embeddings功能，向量化处理是一个计算密集型任务，使用Worker线程可以提高性能。

3. **大文件处理**：对于大文件的处理，使用Worker线程可以避免阻塞主线程。

### 17.2 Worker线程的实现考虑
1. **线程池管理**：需要实现一个Worker线程池，避免创建过多线程导致系统资源耗尽。

2. **任务队列**：需要实现任务队列来管理需要在Worker线程中执行的任务。

3. **数据传输**：需要注意Worker线程与主线程之间的数据传输开销，尽量减少数据传输。

4. **错误处理**：需要实现Worker线程中的错误处理机制。

### 17.3 实施建议
1. 初期实现可以不使用Worker线程，确保基本功能的稳定性。

2. 在后续优化阶段，根据性能测试结果决定是否引入Worker线程。

3. 优先考虑在内容提取和向量化处理中使用Worker线程。

## 18. 潜在缺陷和改进方向

### 18.1 潜在缺陷

1. **文件系统监听的稳定性**：
   - 在某些操作系统或文件系统环境下，文件系统监听可能不稳定
   - 符号链接和硬链接可能导致重复索引或循环索引问题

2. **索引性能问题**：
   - 初次索引大量文件时可能耗时较长
   - 在低性能设备上可能影响用户体验

3. **内存使用问题**：
   - 索引大量文件时可能占用较多内存
   - 文件内容缓存可能占用大量内存

4. **文件类型支持限制**：
   - 某些特殊文件类型可能无法正确解析
   - 新增文件类型需要额外开发支持

5. **跨平台兼容性问题**：
   - 不同操作系统的文件系统差异可能导致兼容性问题
   - 文件路径分隔符和编码问题

### 18.2 改进方向

1. **索引算法优化**：
   - 实现更高效的索引算法
   - 优化数据库查询性能

2. **资源管理优化**：
   - 实现更智能的内存管理
   - 优化文件系统监听性能

3. **用户体验改进**：
   - 提供更详细的索引进度反馈
   - 实现更灵活的配置选项

4. **功能扩展**：
   - 支持云存储文件索引
   - 实现全文搜索功能
   - 提供更智能的文件推荐

5. **错误处理和恢复**：
   - 实现更完善的错误处理机制
   - 提供索引恢复功能
